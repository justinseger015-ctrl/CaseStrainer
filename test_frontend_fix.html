<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frontend Data Processing Fix Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .citation { margin: 10px 0; padding: 10px; background: #f8f9fa; }
        .cluster { margin: 10px 0; padding: 10px; background: #e9ecef; }
    </style>
</head>
<body>
    <h1>üîß Frontend Data Processing Fix Test</h1>
    
    <div class="test-section">
        <h2>üìä Testing Normalized Data Access</h2>
        <p>This test simulates the fixed frontend data processing logic.</p>
        <button onclick="testNormalizedDataAccess()">Test Normalized Data Access</button>
    </div>
    
    <div id="results" class="test-section">
        <h2>üìã Test Results</h2>
        <div id="test-output"></div>
    </div>
    
    <script>
        // Simulate the backend response (same as before)
        const backendResponse = {
            "metadata": {
                "status": "completed",
                "success": true
            },
            "result": {
                "citations": [
                    {
                        "canonical_date": "2014-01-14",
                        "canonical_name": "Knight v. Knight",
                        "citation": "317 P.3d 1068",
                        "confidence_score": 0.7,
                        "extracted_case_name": "In re Vulnerable Adult Petition for Knight",
                        "extracted_date": "2014-01-14",
                        "extraction_method": "unified_processor",
                        "false_positive_filtered": false,
                        "source": "CourtListener Citation-Lookup API v4",
                        "url": null,
                        "validation_method": "citation_lookup_v4_only",
                        "verification_confidence": 0.7,
                        "verified": true
                    },
                    {
                        "canonical_date": "2014",
                        "canonical_name": "In re Marriage of Black",
                        "citation": "188 Wn.2d 114",
                        "confidence_score": 0.7,
                        "extracted_case_name": "In re Marriage of Black",
                        "extracted_date": "2014",
                        "extraction_method": "unified_processor",
                        "false_positive_filtered": false,
                        "source": "citation_object",
                        "url": null,
                        "validation_method": "object_extraction",
                        "verification_confidence": 0.7,
                        "verified": false
                    }
                ],
                "clusters": [
                    {
                        "case_name": "In re Vulnerable Adult Petition for Knight",
                        "citations": ["317 P.3d 1068", "178 Wn. App. 929"],
                        "cluster_id": "Knight_2014-01-14",
                        "cluster_type": "case_name_year",
                        "size": 2,
                        "year": "2014-01-14"
                    },
                    {
                        "case_name": "In re Marriage of Black",
                        "citations": ["188 Wn.2d 114"],
                        "cluster_id": "Black_2014",
                        "cluster_type": "case_name_year",
                        "size": 1,
                        "year": "2014"
                    }
                ]
            },
            "status": "completed",
            "success": true
        };
        
        // Simulate the fixed frontend data access logic
        function getNormalizedData(props) {
            const normalizedCitations = (() => {
                // Backend sends: result.citations
                if (props?.result?.citations && Array.isArray(props.result.citations)) {
                    return props.result.citations;
                }
                // Fallback to old structure
                if (props?.citations && Array.isArray(props.citations)) {
                    return props.citations;
                }
                return [];
            })();
            
            const normalizedClusters = (() => {
                // Backend sends: result.clusters
                if (props?.result?.clusters && Array.isArray(props.result.clusters)) {
                    return props.result.clusters;
                }
                // Fallback to old structure
                if (props?.clusters && Array.isArray(props.clusters)) {
                    return props.clusters;
                }
                return [];
            })();
            
            return { normalizedCitations, normalizedClusters };
        }
        
        function testNormalizedDataAccess() {
            const output = document.getElementById('test-output');
            output.innerHTML = '';
            
            try {
                // Test 1: Check normalized data access
                output.innerHTML += '<h3>‚úÖ Test 1: Normalized Data Access</h3>';
                const { normalizedCitations, normalizedClusters } = getNormalizedData(backendResponse);
                
                output.innerHTML += `<p><strong>Citations found:</strong> ${normalizedCitations.length}</p>`;
                output.innerHTML += `<p><strong>Clusters found:</strong> ${normalizedClusters.length}</p>`;
                
                // Test 2: Process citations using normalized data
                output.innerHTML += '<h3>‚úÖ Test 2: Citations Processing (Fixed)</h3>';
                normalizedCitations.forEach((citation, index) => {
                    output.innerHTML += `
                        <div class="citation">
                            <strong>Citation ${index + 1}:</strong> ${citation.citation}<br>
                            <strong>Extracted Name:</strong> ${citation.extracted_case_name || 'N/A'}<br>
                            <strong>Canonical Name:</strong> ${citation.canonical_name || 'N/A'}<br>
                            <strong>Extracted Date:</strong> ${citation.extracted_date || 'N/A'}<br>
                            <strong>Canonical Date:</strong> ${citation.canonical_date || 'N/A'}<br>
                            <strong>Status:</strong> ${citation.verified ? 'verified' : 'unverified'}<br>
                            <strong>Source:</strong> ${citation.source || 'Unknown'}<br>
                            <strong>Confidence:</strong> ${citation.confidence_score || 'N/A'}
                        </div>
                    `;
                });
                
                // Test 3: Process clusters using normalized data
                output.innerHTML += '<h3>‚úÖ Test 3: Clusters Processing (Fixed)</h3>';
                normalizedClusters.forEach((cluster, index) => {
                    output.innerHTML += `
                        <div class="cluster">
                            <strong>Cluster ${index + 1}:</strong> ${cluster.case_name}<br>
                            <strong>Citations:</strong> ${cluster.citations.join(', ')}<br>
                            <strong>Year:</strong> ${cluster.year}<br>
                            <strong>Size:</strong> ${cluster.size}
                        </div>
                    `;
                });
                
                // Test 4: Verify no N/A values from data processing
                output.innerHTML += '<h3>‚úÖ Test 4: Data Quality Check</h3>';
                let hasNAs = false;
                normalizedCitations.forEach(citation => {
                    if (citation.extracted_case_name === 'N/A' || citation.canonical_name === 'N/A') {
                        hasNAs = true;
                    }
                });
                
                if (hasNAs) {
                    output.innerHTML += '<div class="test-section error"><h3>‚ùå N/A Values Detected!</h3><p>Data processing is still showing N/A values.</p></div>';
                } else {
                    output.innerHTML += '<div class="test-section success"><h3>üéâ No N/A Values!</h3><p>Data processing is working correctly with normalized access.</p></div>';
                }
                
                output.innerHTML += '<div class="test-section success"><h3>üéâ All Tests Passed!</h3><p>The frontend data processing fix is working correctly.</p></div>';
                
            } catch (error) {
                output.innerHTML += `<div class="test-section error"><h3>‚ùå Test Failed</h3><p>Error: ${error.message}</p></div>`;
            }
        }
    </script>
</body>
</html>
