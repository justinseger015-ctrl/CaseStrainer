import { defineConfig, loadEnv } from 'vite';
import vue from '@vitejs/plugin-vue';
import { fileURLToPath } from 'node:url';
import { resolve } from 'node:path';

// https://vitejs.dev/config/
export default defineConfig(({ mode }) => {
  // Load environment variables based on the current mode
  const env = loadEnv(mode, process.cwd(), '');
  
  return {
    plugins: [
      vue({
        // Vue 3.3+ features
        script: {
          defineModel: true,
          propsDestructure: true
        }
      })
    ],
    
    // Base public path when served in production
    base: env.NODE_ENV === 'production' ? '/casestrainer/' : '/',
    
    // Development server configuration
    server: {
      port: 5173, // Standard Vite dev port
      strictPort: true,
      host: '0.0.0.0', // Bind to all interfaces for Docker
      allowedHosts: [
        'localhost',
        '127.0.0.1',
        '0.0.0.0',
        'wolf.law.uw.edu'
      ],
      proxy: {
        // Proxy API requests to the backend server during development
        '/casestrainer/api': {
          target: 'http://localhost:5000',
          changeOrigin: true,
          secure: false,
          ws: true,
          configure: (proxy, _options) => {
            proxy.on('error', (err, _req, _res) => {
              console.error('Proxy error:', err);
            });
            proxy.on('proxyReq', (proxyReq, req, _res) => {
              console.log('Sending Request to the Target:', req.method, req.url);
            });
          }
        },
      },
    },
    
    // Preview server configuration (for production builds)
    preview: {
      port: parseInt(process.env.PROD_FRONTEND_PORT) || 5000,
      host: '127.0.0.1',
      strictPort: true,
      proxy: {
        '/api': {
          target: `http://localhost:${process.env.PROD_BACKEND_PORT || 5002}`,
          changeOrigin: true,
          secure: false,
          ws: true
        }
      }
    },
    
    // Build configuration
    build: {
      outDir: 'dist',
      assetsDir: 'assets',
      sourcemap: false,
      minify: false,
      chunkSizeWarningLimit: 1600,
      // Disable the brotli compressed size reporting for slightly faster builds
      brotliSize: false,
      // Simplify the rollup options
      rollupOptions: {
        output: {
          manualChunks: {
            vendor: ['vue', 'vue-router']
          },
          // Simplify file naming to prevent issues
          entryFileNames: 'assets/[name]-[hash].js',
          chunkFileNames: 'assets/[name]-[hash].js',
          assetFileNames: 'assets/[name]-[hash][extname]'
        }
      }
    },
    
    // Add cache busting for HTML
    // Note: This is handled by the rollupOptions above
    
    // Resolve aliases
    resolve: {
      alias: {
        '@': fileURLToPath(new URL('./src', import.meta.url)),
        // Optional: Additional aliases
        // '@components': fileURLToPath(new URL('./src/components', import.meta.url)),
        // '@views': fileURLToPath(new URL('./src/views', import.meta.url)),
        // '@utils': fileURLToPath(new URL('./src/utils', import.meta.url)),
      },
    },
    
    // CSS configuration
    css: {
      preprocessorOptions: {
        scss: {
          additionalData: `@import "@/styles/variables.scss";`
        }
      },
      // CSS modules configuration
      modules: {
        localsConvention: 'camelCase'
      }
    },
    
    // Optimization dependencies
    optimizeDeps: {
      include: ['vue', 'vue-router'],
      // exclude: ['some-dep']
    },
    
    // Environment variables to expose to the client
    define: {
      'import.meta.env.VITE_APP_NAME': JSON.stringify(env.VITE_APP_NAME || 'CaseStrainer'),
      'import.meta.env.VITE_APP_ENV': JSON.stringify(env.VITE_APP_ENV || 'development'),
      'import.meta.env.VITE_API_BASE_URL': JSON.stringify(
        env.VITE_APP_ENV === 'production' 
          ? '/casestrainer/api' 
          : 'http://localhost:5000/casestrainer/api'
      ),
      'import.meta.env.DEV_FRONTEND_PORT': JSON.stringify(process.env.DEV_FRONTEND_PORT || '5000'),
      'import.meta.env.DEV_BACKEND_PORT': JSON.stringify(process.env.DEV_BACKEND_PORT || '5001'),
      '__APP_VERSION__': JSON.stringify(version),
      // Optional: Global constants
      // __VUE_OPTIONS_API__: true,
      // __VUE_PROD_DEVTOOLS__: false,
    },
    
    // ESBuild configuration
    esbuild: {
      drop: env.VITE_APP_ENV === 'production' ? ['console', 'debugger'] : []
    },
    
    // Worker configuration
    worker: {
      format: 'es'
    }
  };
});